# Server-side template injection with a custom exploit

![image](https://user-images.githubusercontent.com/68894302/179499624-740af349-d429-4458-9d18-ec832120ae73.png)

Ứng dụng này vẫn là một blog nơi người dùng có thể nhận xét về các blog hiện có. Ngoài ra trong hồ sơ người dùng người dùng có thể chọn tên mình muốn hiển thị khi nhận xét về bài đăng trên các blog, ngoài ra còn chức năng tải lên hình ảnh làm avartar.

+ Chọn tên ưa thích và nhấp vào submit

  ![image](https://user-images.githubusercontent.com/68894302/179502137-34362524-1bcb-4236-bdfa-31cbad6dd427.png)

+ Ghi lại yêu cầu này trong burp và gửi nó đến reepeater

  ![image](https://user-images.githubusercontent.com/68894302/179502229-531c03e5-389d-47fe-b9ed-cff35cbf081f.png)

+ Bây giờ thêm payload inject template đơn giản trong __blog-post-author-display__ và gửi yêu cầu

  **Payload**: }}{{70*10}}

  ![image](https://user-images.githubusercontent.com/68894302/179502499-7754a15c-4564-4885-96ee-20f03c841862.png)

+ F5 làm mới lại trình duyệt

+ Bây giờ đi đến phần trang chủ và thâm nhận xét mới về các bài đăng hiện có, payload SSTI sẽ được thực thi và đưa ra kết quả là tên người dùng theo sau là 770 sau khi thêm nhận xét

  ![image](https://user-images.githubusercontent.com/68894302/179502399-498ac3ed-d745-4185-9db8-434cdb10cf01.png)

+ Nhưng sau khi chèn payload `}}${{<%[%'"}}%\` thì ta thấy từ traceback ứng dụng đang sử dụng Twig

  ![image](https://user-images.githubusercontent.com/68894302/179504308-76b06037-8823-4b69-8273-727a074e6093.png)

+ Nếu người dùng upload file ảnh không tồn tại thì cũng xảy ra thông báo lỗi như sau:

  ![image](https://user-images.githubusercontent.com/68894302/179504727-4b93df93-678f-4bdd-9d0a-2fdf33cbf016.png)

  Từ error kia chúng ta thấy rằng chức năng kiểm tra image được thực thi trong file __User.php__ và hàm setAvartar() có lẽ cũng để kiểm tra xem có phải image không nếu có thì cho phép tải lên hình ảnh

  Cho đối tượng user trỏ đến hàm setAvatar và đặt `/etc/passwd` làm đối số

  ![image](https://user-images.githubusercontent.com/68894302/179506430-4d85d35d-ed3e-482a-8b18-ab162bf3eaac.png)

  Một thông báo lỗi được ném ra có lẽ nó kiểm tra file này không có mime type dạng image nên chưa cho phép tải lên, thêm `image/png` vào và load lại thì

  ![image](https://user-images.githubusercontent.com/68894302/179506598-6961e9f3-34ad-4c8f-8587-5736eb86d845.png)

  Như vậy là đã thành công trong việc setAvatar và ứng dụng trả về nội dung toàn bộ file đó. Bây giờ set nó thành `/home/carlos/User.php` để đọc file này

  ![image](https://user-images.githubusercontent.com/68894302/179506873-666d0da3-6fb4-4358-aaf3-27ab8bc00b99.png)

  Nội dung file __User.php__ đã được trả về, mở trong trình editor để phân tích.

  ![image](https://user-images.githubusercontent.com/68894302/179507264-9a536e45-05ec-4484-bd99-33b91c370fe3.png)

  + Hàm setAvatar tại dòng 27 sẽ kiểm tra nếu MIME type xem có bắt đầu bằng `image/` hay không, nếu không thì ném ra ngoại lệ.

    Tức là chúng ta có thể dùng imge/php, image/png, image/jpeg đều được. 

  ![image](https://user-images.githubusercontent.com/68894302/179508109-e15eb9dd-c5f3-4c9f-8ea4-a116028f4c19.png)

  + Hàm gdprDelete() gọi đến hàm __rm()__ để xóa filename, nếu không thể xóa sẽ ném ra ngoại lệ. Sau đó  gọi đến hàm __delete()__. 

  Đề bài yêu cầu xóa file __/.ssh/id_rsa__ nên ban đầu chúng ta cần đặt nó trong hàm setAvatar() sau đó trỏ đến hàm gdprDelete(). 

  ![image](https://user-images.githubusercontent.com/68894302/179509015-4c0bea04-ba0e-4705-a71c-5475aa40b9ff.png)

  ![image](https://user-images.githubusercontent.com/68894302/179509085-3e567d77-b546-4e8f-b24b-b5316858af61.png)

Nội dung file __id_rsa__ chính là "Nothing to see here :)". Tiếp tục gọi hàm gdprDelete để xóa file này

![image](https://user-images.githubusercontent.com/68894302/179509416-c03a9298-7837-419f-9b56-8088645e974f.png)

Sau khi gửi request và load lại trình duyệt thì challenge được giải quyết

![image](https://user-images.githubusercontent.com/68894302/179509546-1c05c41d-6009-4fe6-8edc-181d125024fd.png)